<!doctype html>
<html lang="en">

<head>
    <title>Planner Leon (c) 20023 </title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width" />
    <!-- <base href="/" /> -->
    <!-- <link href="https://rawgit.com/vitmalina/w2ui/master/dist/w2ui.css" rel="stylesheet" type="text/css" />
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet"
        type="text/css" /> -->
    <link href="w2ui.css" rel="stylesheet" type="text/css" />
    <link href="vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />

    <style>
        .vis-item.bookingcom {
            background-color: rgb(196, 221, 253);
            border-color: rgb(22, 2, 59);
            color: rgb(1, 26, 29);
        }

        .vis-item.walkin {
            background-color: rgb(154, 230, 154);
            border-color: rgb(23, 32, 23);
            color: rgb(21, 22, 18);
        }

        .vis-item.abnb {
            background-color: rgb(247, 201, 201);
            border-color: rgb(39, 3, 27);
            color: rgb(27, 6, 46);
        }


        .vis-item.closed {
            background-color: black;
            border-color: black;
            color: rgb(255, 255, 255);
        }


        .vis-item.vis-selected {
            color: black;
        }


        /* alternating column backgrounds */
        .vis-time-axis .vis-grid.vis-odd {
            background: #f5f5f5;
        }

        .w2ui-input[readonly],
        .w2ui-input[disabled] {
            background-image: none;
            background-color: #ffffff !important;
            color: #09053f !important;
        }

        .w2ui-input {
            background-image: none;
            background-color: #ffffff !important;
            color: #09053f !important;
        }


        table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}
th, td {
  padding-top: 5px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
}

    </style>


    <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.5.0/jquery.min.js" type="text/javascript"></script>
    <script src="https://rawgit.com/vitmalina/w2ui/master/dist/w2ui.js" type="text/javascript"></script>
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"
        type="text/javascript"></script> -->

    <script src="jquery.min.js" type="text/javascript"></script>
    <script src="w2ui.js" type="text/javascript"></script>
    <script src="vis-timeline-graph2d.min.js" type="text/javascript"></script>

</head>

<body>

    <button id="hide">Hide</button> <button id="show">Show</button>
    <br>
    <br>
    <div id="myForm" style="width:'100%';height:'100%'"></div>

    <br>
    <div id="visualization"></div>
    <br>

    <script>



        function financial(x) {
            if (x){
                return Number.parseFloat(x).toFixed(2);
                // .replace('.', ',');
            } 
            return Number.parseFloat(0).toFixed(2);
            // .replace('.', ',');
        }


        function convertDate(str) {
            var parts = str.split("/");
            var dt = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
            dt.setHours(12, 0, 0);

            return dt;
        }


        function convertDate_00_00_00(str) {
            var parts = str.split("/");
            var dt = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
            dt.setHours(0, 0, 0);

            return dt;
        }

        function initForm() {

            w2ui['myForm'].setValue('startDate', formattedDate(new Date));
            w2ui['myForm'].setValue('endDate', formattedDate(new Date));
            w2ui['myForm'].setValue('numOfNights', 0);


            w2ui['myForm'].setValue('status',  { id: 'active', text: 'Active' } );


            w2ui['myForm'].setValue('balance', null);
            w2ui['myForm'].setValue('charge', null);
            w2ui['myForm'].setValue('received', null);
            w2ui['myForm'].setValue('commission', null);
            w2ui['myForm'].refresh();

        }

        function formattedDate(d = new Date) {
            let month = String(d.getMonth() + 1);
            let day = String(d.getDate());
            const year = String(d.getFullYear());

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return `${day}/${month}/${year}`;
        }



        $(document).ready(function () {
            $("#hide").click(function () {
                // $("#save").hide();
                $('[name="save"]').hide();
                $('[name="reset"]').hide();
                w2ui.myForm.hide('name', 'numOfGuests', 'numOfNights',  'charge', 'identification', 'email', 'extraInfo')

            });
            $("#show").click(function () {
                // $("#myForm").show();
                // $("#save").show();
                $('[name="save"]').show();
                $('[name="reset"]').show();
                w2ui.myForm.show('name', 'numOfGuests', 'numOfNights',  'charge', 'identification', 'email', 'extraInfo')
            });
        });


        var nowISOString = new Date().toISOString().substring(0, 10);
        var moveToDate = new Date();// set to current date 


        // initialise vis timeline componenet 
        var groups = new vis.DataSet();
        // var items = new vis.DataSet();

        var items = new vis.DataSet({
            type: { start: "ISODate", end: "ISODate" },
        });


        var container = document.getElementById('visualization');

        var options = {


            maxHeight: 2000,
            horizontalScroll: true,
            verticalScroll: true,
            zoomKey: "ctrlKey",

            start: Date.now() - 1000 * 60 * 60 * 24 * 2, // minus 3 days
            end: Date.now() + 1000 * 60 * 60 * 24 * 17, // plus 1 months aprox.

            // zoomMin: 1000 * 60 * 60 * 24 * 16,             // 16  day in milliseconds
            // zoomMax: 1000 * 60 * 60 * 24 * 29 * 1,         // about 1  months in milliseconds

            showCurrentTime: true,

            clickToUse: false,

            tooltip: {
                followMouse: true,
            },

            stack: false,

            // editable: true,

            editable: {
                add: false,
                remove: true
            },


            // moment: function(date) {
            //     return  vis.moment(date).utc().utcOffset('+02:00');  // greek utc time 
            // },

            orientation: {
                axis: "both",
                item: "top"
            },

            showMinorLabels: true,
            timeAxis: { scale: 'day', step: 1 },
            format: {
                minorLabels: {
                    millisecond: '',
                    second: '',
                    minute: '',
                    hour: '',
                    weekday: '',
                    day: 'DD ddd',
                    month: '',
                    year: ''
                }
            },


            onRemove: function (item, callback) {

                var pojo = JSON.stringify(items.get(item.id).recordData);

                $.ajax({
                    type: 'POST',
                    url: '/booking/delete',
                    contentType: 'application/json',
                    data: pojo,
                    success: function (data, status, xhr) {
                        // alert('status: ' + status + ', data: ' + data);
                        callback(item); // do remove 
                    }
                });
            }

        };
        timeline = new vis.Timeline(container, null, options);
        timeline.setGroups(groups);
        timeline.setItems(items);
        timeline.setCurrentTime(Date.now());




        // add some rooms   
        var roomList = [
            {
                id: 'APT2',
                text: 'APT 2'
            },
            {
                id: 'APT6',
                text: 'APT 6'
            },
            {
                id: 'STU7',
                text: 'STU 7'
            },
            {
                id: 'STU8',
                text: 'STU 8'
            },
            {
                id: 'STU9',
                text: 'STU 9'
            },
            {
                id: 'STU10',
                text: 'STU 10'
            },
            {
                id: 'STU11',
                text: 'STU 11'
            },
            {
                id: 'STU12',
                text: 'STU 12'
            },
            {
                id: 'POT',
                text: 'POTIDEION'
            },
            {
                id: 'MER',
                text: 'MERTONAS'
            }


        ];  // for the dropdown  select room 


        // roomList.push({
        //         id: idVal,
        //         text: descVal
        //     });

        for (let i = 0; i < roomList.length; i++) {

            var idVal = roomList[i].id;
            var descVal = roomList[i].text;
            groups.add({
                id: idVal,
                content: descVal
                // , order: 1
            });
        }


        var agencyList = [
            { id: 'abnb', text: 'AirBnB' },
            { id: 'bookingcom', text: 'Booking.com' },
            { id: 'walkin', text: 'Walk-in' },
            { id: 'closed', text: 'Closed' },
        ];


        
        var statusList = [
            { id: 'active', text: 'Active' },
            { id: 'cancelled', text: 'Cancelled' }
        ];



        // set globals 
        w2utils.settings.dateFormat = 'yyyy-mm-dd';
        // w2utils.settings.currencyPrefix = 'â‚¬';

        var countryList = [
            
            "Austria", "Belgium","Bosnia", "Brazil", "Bulgaria", "Dudai", "Denmark", "England", "France","Norway","Poland", 
            "Finland",  "Germany", "Ireland", "Italy","Israel", "America", "Australia", "Albania",  "Argentina",
            "Canada", "Chile", "China", "Colombia", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic", 
            "Egypt", "El Salvador", "Estonia", "Greenland", "Georgia", "Greece", "Hong Kong", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq",  "Isle of Man", 
            "Jamaica", "Japan",  "Latvia", "Lebanon", "Lithuania", "Luxembourg", 
            "Malta", "Mexico", "Monaco", "Montenegro", "Morocco", 
            "Netherlands", "New Zealand", "Pakistan", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Portugal","Puerto Rico", 
            "Qatar", "Romania", "Russia", 
            "Skopia", "Saudi Arabia",  "Singapore",  "South Africa", "South Korea", "Sweden" , "Switzerland","Serbia", "Slovakia", "Slovenia","Spain",
            "Turkey","Ukraine", "Other" ];










        // setup form with w2ui 
        $(function () {


            $('#myForm').w2form({
                name: 'myForm',

                // header: 'Form with Toolbar',


                // toolbar: {
                //     items: [
                //         { id: 'bt1', type: 'button', text: 'Button 1', img: 'icon-folder' },
                //         { id: 'bt2', type: 'button', text: 'Button 2', img: 'icon-folder' },
                //         { id: 'bt3', type: 'spacer' },
                //         { id: 'bt4', type: 'button', text: 'GotoToday', img: 'icon-page' },
                //         { id: 'bt5', type: 'button', text: 'Save', img: 'icon-page' }
                //     ],
                //     onClick(event) {
                //         if (event.target == 'bt4') {

                //         }


                //         if (event.target == 'bt5') alert('save test');
                //     }
                // },


                // url      : {
                //     get  : '/server/url/to/get',
                //     save : '/booking/save'
                // },

                // need to set url  for save  and get 
                fields: [

                    {
                        field: 'name', type: 'text',
                        required: true,
                        html: {
                            label: 'Name',
                            text: '&nbsp; &nbsp; %anchorAgency%   &nbsp; &nbsp;  %anchorRoom%  &nbsp; &nbsp;   %anchorCountry% &nbsp; &nbsp; %anchorStatus%',
                            attr: 'style="  text-transform: uppercase; width: 300px; font-weight: bold; text-align:center; "'
                        }
                    },

                    {
                        field: 'status', type: 'list',
                        required: true,
                        html: {
                            label: 'Status ',
                            anchor: '%anchorStatus%',
                            attr: 'style=" width: 100px;  font-weight: bold;  text-align:center;"'
                        },
                        options: { items: statusList
                            // , selected : { id: 'active' }
                          }
                    },


                    // Line   Customer,Agency,Voucher 
                    {
                        field: 'agency', type: 'list',
                        required: true,
                        html: {
                            label: '&nbsp; &nbsp; Agency &nbsp;  &nbsp; ',
                            anchor: '%anchorAgency%',
                            // text: '&nbsp;  %anchorVoucher% &nbsp; &nbsp;',
                            attr: 'style=" width: 100px;  font-weight: bold;  text-align:center;"'
                        },
                        options: { items: agencyList }
                    },



                    // Line  Room
                    {
                        field: 'room', type: 'list',
                        required: true,
                        html: {
                            label: '&nbsp; &nbsp; Room &nbsp;',
                            anchor: '%anchorRoom%',
                            attr: 'style="  width: 100px; font-weight: bold; text-align:center; "'
                        },
                        options: { items: roomList }
                    },



                    // Line 3 startDate, endDate,  numOfNights


                    {
                        field: 'startDate', type: 'date',
                        // format: 'd.m.yyyy',  
                        // todo now using isoDate format as vis timeline is configured as iso 
                        required: true,
                        html: {
                            label: '&nbsp;&nbsp;&nbsp; From ',
                            text: '&nbsp;  &nbsp;  &nbsp;   %anchorEndDate%  %anchorNumOfNights%   %anchorNumOfGuests% ',
                            attr: 'style="  width: 100px; font-weight: bold; text-align:center;"'
                        },
                        options: {
                            // start: new Date().toISOString().substring(0, 10) // nowISOString  e.g. '2023-02-25'  
                            // end: query('input[type=endDate]')[0] ,
                            // start: formattedDate(new Date()),
                            format: 'dd/mm/yyyy'
                            // all dates before start will be unselectable
                        }
                    },


                    {
                        field: 'numOfGuests', type: 'list',
                        required: true,
                        html: {
                            label: '&nbsp;  &nbsp;  &nbsp;  Num. Of Guests &nbsp; ',
                            anchor: '%anchorNumOfGuests%',
                            attr: 'style="  width: 50px; font-weight: bold; text-align:center;"'
                        },
                        // options: { min: 1, max: 6 }
                        options: { items: [1, 2, 3, 4, 5, 6] }
                    },

                    {

                        field: 'endDate', type: 'date',
                        required: true,
                        // on endDate change  calculate  numOfNights  from start date and endDate  
                        html: {
                            label: '&nbsp;&nbsp;&nbsp; To &nbsp;&nbsp;&nbsp;&nbsp; ',
                            anchor: '%anchorEndDate%',
                            attr: 'style=" width: 100px; font-weight: bold; text-align:center;"'
                        },
                        options: {
                            // start: query('input[type=startDate]')[0]
                            // start: formattedDate(new Date()), 
                            format: 'dd/mm/yyyy'
                        }
                    },

                    {
                        field: 'numOfNights', type: 'int',
                        required: true,
                        disabled: true,
                        // Todo:  on numOfNights change  calculate  endDate from start date 
                        html: {
                            label: '&nbsp; Nights &nbsp;',
                            anchor: '%anchorNumOfNights%',
                            attr: 'style="width: 50px; font-weight: bold; text-align:center;"'
                        },
                        options: { min: 1 }

                    },

                    {
                        field: 'country', type: 'list',
                        html: {
                            label: 'Country &nbsp;  &nbsp; ',
                            anchor: '%anchorCountry%',
                            attr: ' style="width: 135px;  text-align:center; "'
                        },
                        options: {
                            items: countryList
                        }
                    },

                    // Line 4  Money
                    {
                        field: 'charge', type: 'float',
                        // required: true,
                        html: {
                            label: 'Total',
                            text: 'â‚¬ &nbsp; %anchorCommission%  â‚¬ &nbsp; %anchorReceived% â‚¬ &nbsp; %anchorBalance% â‚¬ ',
                            attr: 'style="width: 80px; font-weight: bold; text-align:center; "'
                        },
                        options: { groupSymbol: '' 
                        // , decimalSymbol:','
                                }

                    },

                    {
                        field: 'commission', type: 'float',
                        // required: true,
                        html: {
                            label: '&nbsp; &nbsp;  &nbsp;  &nbsp; &nbsp; &nbsp; Commission &nbsp; &nbsp; ',
                            anchor: '%anchorCommission%',
                            attr: 'style="width: 80px; font-weight: bold; text-align:center; "'
                        },
                        options: { groupSymbol: ''
                        // , decimalSymbol:',' 
                                }
                    },

                    {
                        field: 'received', type: 'float',
                        // required: true,
                        html: {
                            label: '&nbsp; &nbsp;  &nbsp;  &nbsp; &nbsp; &nbsp; Received &nbsp; &nbsp; ',
                            anchor: '%anchorReceived%',
                            attr: 'style="width: 80px; font-weight: bold; text-align:center; "'
                        },
                        options: { groupSymbol: ''
                        // , decimalSymbol:','
                                }
                    },
                    {
                        field: 'balance', type: 'float',
                        // required: true,
                        disabled: true,
                        html: {
                            label: '&nbsp; &nbsp; &nbsp; Balance &nbsp; &nbsp;',
                            anchor: '%anchorBalance%',
                            attr: 'style="width: 80px; font-weight: bold; text-align:center;"'
                        },
                        options: { groupSymbol: '' 
                        // ,decimalSymbol:',' 
                             }
                    },


                    // Line 5     Identification, AFM
                    {
                        field: 'identification', type: 'text',
                        // required: true,
                        html: {
                            label: 'ID &nbsp;',
                            text: '&nbsp;  &nbsp; %anchorAfm% %anchorVoucher%  ',
                            attr: 'style="width: 220px; text-transform: uppercase; font-weight: bold;  text-align:center;"'
                        }
                    },



                    {
                        field: 'afm', type: 'text',
                        // required: true,
                        html: {
                            label: 'TAX ID &nbsp;',
                            anchor: '%anchorAfm%',
                            attr: 'style="width: 220px; text-transform: uppercase; font-weight: bold;  text-align:center;"'
                        }
                    },


                    {
                        field: 'taxRefNumber', type: 'text',
                        // required: true,
                        html: {
                            label: '&nbsp; &nbsp;  S/N Declaration &nbsp; ',
                            anchor: '%anchortaxRefNumber%',
                            attr: 'style="width: 220px; text-transform: uppercase; font-weight: bold;  text-align:center;"'
                        }
                    },


                    {
                        field: 'email', type: 'email',
                        html: {
                            label: 'Email',
                            text: '&nbsp; &nbsp; %anchorTel%  &nbsp; %anchortaxRefNumber% ',
                            attr: 'style="width: 300px; text-align:center;"'
                        }
                    },
                    {
                        field: 'tel', type: 'int',
                        html: {
                            label: 'Tel. &nbsp; ',
                            anchor: '%anchorTel%',
                            attr: 'style="width: 160px; text-align:center;"'
                        }
                    },
                    {
                        field: 'voucher', type: 'text',
                        html: {
                            label: '&nbsp; &nbsp; &nbsp; &nbsp;   Voucher   &nbsp; &nbsp; ',
                            anchor: '%anchorVoucher%',
                            attr: 'style="width: 220px;  text-transform: uppercase; font-weight: bold; text-align:center;"'
                        }
                    },

                    // Line 5  Extra Info 
                    {
                        field: 'extraInfo', type: 'textarea',
                        html: {
                            label: 'Notes ',
                            text: ' &nbsp; %anchorInvoiceNumber%  ',
                            attr: 'style="width: 500px; height: 60px; resize: none" '
                        }
                    },
                   
                    {
                        field: 'invoiceNumber', type: 'text',
                        // required: true,
                        html: {
                            label: ' &nbsp;&nbsp; &nbsp; Invoice Number &nbsp;',
                            anchor: '%anchorInvoiceNumber%',
                            attr: 'style="width: 220px; text-transform: uppercase; font-weight: bold;  text-align:center;"'
                        }
                    },




                ],


                actions: {


                    // find: {
                    //     text: 'find',
                    //     class: 'w2ui-btn-grey',
                    //     style: 'text-transform: uppercase; width: 100px;  color: white ; font-size: 12px;',
                    //     onClick(event) {

                    //         var find  =   w2ui.myForm.getValue('name');
                    //         alert ( ' TODO   ' + find );

                    //         // todo goto back end and search 

                    //         // var  filteredItems = items.get({
                    //         // filter: item => {
                    //         //     return item.name === find;
                    //         // }
                    //         // });

                    //         // alert ( '' +  filteredItems[0].start );
                            
                    //         // var gotoDate  =  filteredItems[0].start ;
                    //         // timeline.moveTo(gotoDate, { animation: true });



                    //     }
                    // },

                                       

                    report:{


                        text: 'report',
                        class: 'w2ui-btn-blue',
                        style: 'text-transform: uppercase; width: 100px;  color: white ; font-size: 12px;',
                        onClick(event) {


                            $.ajax({
                                    type: 'GET',
                                    url: '/booking/report',
                                    data: { 
                                        fromDate: w2ui.myForm.getValue('startDate'),
                                        toDate: w2ui.myForm.getValue('endDate')
                                     },
                                    contentType: 'application/json',
                                    success: function (data, status, xhr) {

                                        var     contentHtml =  data ;  

                                        w2popup.open({
                                                    title: 'Report ',
                                                    // with: 300,
                                                    // height: 500,
                                                    showMax: true,
                                                    openMaximized: true,
                                                    body:     contentHtml  ,
                                                    actions: { Ok: w2popup.close }
                                                });

                                    }
                            });  // ajax 


                        }
                    },

                    goto: {
                        text: 'goto',
                        class: 'w2ui-btn-blue',
                        style: 'text-transform: uppercase; width: 100px;  color: white ; font-size: 12px;',
                        onClick(event) {

                            var gotoDate  =    convertDate(w2ui.myForm.getValue('startDate')).setHours(12, 0, 0);
                            // moveToDate = gotoDate;

                            timeline.moveTo(gotoDate, { animation: true });
                          
                        }
                    },

                    today: {
                        text: 'Today',
                        class: 'w2ui-btn-blue',
                        style: 'text-transform: uppercase;  width: 100px; color: white; font-size: 12px; ',
                        onClick(event) {
                            moveToDate = new Date();
                            timeline.moveTo(moveToDate, { animation: true });
                        }
                    },
                   

                    save: {
                        text: 'save',
                        class: 'w2ui-btn-green',
                        style: 'text-transform: uppercase; color: white; width: 200px;  font-size: 12px; ',
                        onClick(event) {

                            if (w2ui.myForm.validate().length == 0) {


                                // retrieve a filtered subset of the data
                                var fItems = items.get({
                                    filter: function (item) {
                                        // var a_start = Date.parse(w2ui.myForm.getValue('startDate'));
                                        // var a_end = Date.parse(w2ui.myForm.getValue('endDate'));
                                        // var b_start = Date.parse(item.start);
                                        // var b_end = Date.parse(item.end);

                                        // alert('   ' + w2ui.myForm.getValue('startDate') + '   ' + w2ui.myForm.getValue('endDate') + '  \n ' +
                                        //     '   ' + item.start + '   ' + item.end + '  \n '
                                        // )

                                        var a_start = convertDate(w2ui.myForm.getValue('startDate'));
                                        var a_end = convertDate(w2ui.myForm.getValue('endDate'));

                                        var b_start = item.start;
                                        var b_end = item.end;



                                        if (w2ui.myForm.getValue('room').id == item.group) {
                                            if (a_start <= b_start && b_start < a_end) return true;    // b starts in a
                                            if (a_start < b_end && b_end < a_end) return true;       // b ends in a
                                            if (b_start < a_start && a_end <= b_end) return true;     // a in b
                                        }
                                        return false;
                                    }
                                });
                                if (fItems != null && fItems.length > 0) {

                                    w2popup.open({
                                        title: 'Message',
                                        with: 300,
                                        height: 150,
                                        body: 'Room is NOT available',
                                        actions: { Ok: w2popup.close }
                                    });

                                }
                                else {
                                    // do save  



                                    // var newId = JSON.stringify(w2ui.myForm.getValue('room').id + '_' + w2ui.myForm.getValue('startDate') + '_' + w2ui.myForm.getValue('endDate'))

                                    var newItem = {
                                            id: null,
                                            // type: 'range',
                                            group: w2ui.myForm.getValue('room').id,
                                            // start: w2ui.myForm.getValue('startDate'),
                                            // end: w2ui.myForm.getValue('endDate'),
                                            start: convertDate(w2ui.myForm.getValue('startDate')).setHours(12, 0, 0),
                                            end: convertDate(w2ui.myForm.getValue('endDate')).setHours(12, 0, 0),

                                            content: '(' + w2ui.myForm.getValue('numOfNights') + ') ' + w2ui.myForm.getValue('name'),
                                            
                                            className: w2ui.myForm.getValue('agency').id,
                                            recordData: this.getCleanRecord(),
                                        };


                                  

                                    // alert(JSON.stringify(items.get(newId).recordData, null, 4));
                                    // start: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0),
                                    // end: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59),
                                    // this.save();// todo 

                                    timeline.moveTo(convertDate(w2ui.myForm.getValue('startDate')).setHours(12, 0, 0), { animation: true });  
                                
                                    var pojo = JSON.stringify( newItem.recordData);

                                    $.ajax({
                                        type: 'POST',
                                        url: '/booking/save',
                                        contentType: 'application/json',
                                        data: pojo,
                                        success: function (element, status, xhr) {




                                            if  ( w2ui.myForm.getValue('status').id == 'active'   ){
                                                // only add to timeline if status is active 

                                                items.add({
                                                    id: element.id,
                                                    type: 'range',
                                                    group: element.room,
                                                    // start: element.startDate,
                                                    // end: element.endDate,

                                                    start: convertDate(element.startDate).setHours(12, 0, 0),
                                                    end: convertDate(element.endDate).setHours(12, 0, 0),

                                                    // title: element.title,

                                                    content: '(' + element.numOfNights + ') ' + element.name,
                                                    className: element.agency,
                                                    recordData: element,
                                                });

                                            }


                                            // timeline.setWindow(convertDate(w2ui.myForm.getValue('startDate')).setHours(12, 0, 0),  convertDate(w2ui.myForm.getValue('endDate')).setHours(12, 0, 0), { animation: true }); 

                                            // alert('status: ' + status + ', data: ' + data);
                                            // w2popup.open({
                                            //     title: 'Saved Item ' + status,
                                            //     with: 600,
                                            //     height: 550,
                                            //     body: JSON.stringify(data),
                                            //     actions: { Ok: w2popup.close }
                                            // });

                                        }
                                    });

                                }// else 


                            } else {
                                w2alert("Fix problems then do save");
                            }



                        }
                    },


                    reset: {
                        text: 'clean',
                        class: 'w2ui-btn-red',
                        style: 'text-transform: uppercase; color: blue; font-size: 12px;',
                        onClick(event) {

                            this.clear();
                            timeline.setSelection([]); // unselect timeline item 
                            initForm();

                        }
                    },


                    // left90: {
                    //     text: '<< 90d',
                    //     class: 'w2ui-btn-grey',
                    //     style: 'text-transform: uppercase; color: black;  font-size: 12px; ',  // border: 1px solid black;
                    //     onClick(event) {
                    //         // w2alert('Custom Action')
                    //         moveToDate = new Date(moveToDate.getTime() - (90 * 24 * 60 * 60 * 1000));     /// plus 90 days
                    //         timeline.moveTo(moveToDate, { animation: true });
                    //     }
                    // },

                    // left30: {
                    //     text: '< 30d',
                    //     class: 'w2ui-btn-grey',
                    //     style: 'text-transform: uppercase;  color: black; font-size: 12px;  ',
                    //     onClick(event) {
                    //         // w2alert('Custom Action')
                    //         moveToDate = new Date(moveToDate.getTime() - (30 * 24 * 60 * 60 * 1000));     /// plus 300 days
                    //         timeline.moveTo(moveToDate, { animation: true });
                    //     }
                    // },

                   

                    // right30: {
                    //     text: '30d >',
                    //     class: 'w2ui-btn-grey',
                    //     style: 'text-transform: uppercase;  color: black; font-size: 12px; ',
                    //     onClick(event) {
                    //         // w2alert('Custom Action')
                    //         moveToDate = new Date(moveToDate.getTime() + (30 * 24 * 60 * 60 * 1000));     /// plus 20 days
                    //         timeline.moveTo(moveToDate, { animation: true });
                    //     }
                    // },


                    // right90: {
                    //     text: '90d >>',
                    //     class: 'w2ui-btn-grey',
                    //     style: 'text-transform: uppercase; color: black;  font-size: 12px; ',
                    //     onClick(event) {
                    //         // w2alert('Custom Action')
                    //         moveToDate = new Date(moveToDate.getTime() + (90 * 24 * 60 * 60 * 1000));     /// plus 20 days
                    //         timeline.moveTo(moveToDate, { animation: true });
                    //     }
                    // },

                    


                }
            });



            initForm();


            $.ajax({
                type: 'GET',
                url: '/booking/getAll',
                contentType: 'application/json',
                success: function (data, status, xhr) {

                    // w2popup.open({
                    //     title: 'GET DATA  ' + status,
                    //     with: 600,
                    //     height: 550,
                    //     body: JSON.stringify(data),
                    //     actions: { Ok: w2popup.close }
                    // });



                    // d.setHours(15, 35, 1);

                    data.forEach((element, index, array) => {

                        console.log(element);


                        if (  element.status == 'active' )    {

                            items.add({
                                id: element.id,
                                type: 'range',
                                group: element.room,
                                // start: element.startDate,
                                // end: element.endDate,

                                start: convertDate(element.startDate).setHours(12, 0, 0),
                                end: convertDate(element.endDate).setHours(12, 0, 0),

                                // title: element.title,

                                content: '(' + element.numOfNights + ') ' + element.name,
                                className: element.agency,
                                recordData: element,
                            });

                        }
                        // console.log(element.x); // 100, 200, 300
                        // console.log(index); // 0, 1, 2
                        // console.log(array); // same myArray object 3 times
                    });




                }
            });


            // w2ui.myForm.on('*', function (event) {
            //     console.log('Event: ' + event.type, 'Target: ' + event.target, event);
            // });




            w2ui.myForm.on('change', function (event) {


                //  Event: change Target: startDate 
                if (event != null && event.target == 'startDate') {
                    w2ui['myForm'].setValue('endDate', event.detail.value.current);
                    w2ui['myForm'].setValue('numOfNights', 0);
                    w2ui['myForm'].refresh();
                    // console.dir(  w2ui['myForm'].get('endDate')  )  ;
                }

                //  Event: change Target: endDate 
                if (event != null && event.target == 'endDate') {


                    var startDateFld = w2ui['myForm'].getValue('startDate');
                    var endDateFld = w2ui['myForm'].getValue('endDate');

                    var date1 = convertDate_00_00_00(startDateFld);
                    var date2 = convertDate_00_00_00(endDateFld);

                    // To calculate the time difference of two dates
                    var numOfNights = date2.getTime() - date1.getTime();

                    // To calculate the no. of days between two dates
                    var numOfNights = numOfNights / (1000 * 3600 * 24);

                    // set   numOfNights        
                    //  $("#numOfNights").val(numOfNights);   

                    w2ui['myForm'].setValue('numOfNights', numOfNights.toFixed(0) );

                    w2ui['myForm'].refresh();

                    //  w2ui['form'].set('field_1', { type: 'int' }); 
                    if (numOfNights <= 0) {
                        // w2alert("<b>Error: </b> <br><br> Nights must be more than zero please enter correct dates.");

                        w2popup.open({
                                        title: 'Message',
                                        with: 300,
                                        height: 150,
                                        body: 'Check your booking dates.',
                                        actions: { Ok: w2popup.close }
                                    });

                    }

                    // else {
                    //     w2alert("Numuber Of Nights is calculated as " + numOfNights + " nigths. <br><br> Start: " + startDateFld + "<br> End: " + endDateFld );
                    // } 
                }

                if (event != null && (event.target == 'received' || event.target == 'charge' || event.target == 'commission')) {

                    var chargeVal = financial( w2ui['myForm'].getValue('charge') );
                    var receivedVal = financial(w2ui['myForm'].getValue('received') );
                    var commissionVal = financial(w2ui['myForm'].getValue('commission'));
                    w2ui['myForm'].refresh();

                    var newBalance = chargeVal - receivedVal ;
                    var newBalance = newBalance - commissionVal;
                   
                    w2ui['myForm'].setValue('charge', chargeVal);
                    w2ui['myForm'].setValue('received', receivedVal);
                    w2ui['myForm'].setValue('commission', commissionVal);
                    w2ui['myForm'].setValue('balance', financial( newBalance ) );

                    w2ui['myForm'].refresh();

                }


                w2ui['myForm'].refresh();


            });

          

            // //  Timeline
            timeline.on('click', function (properties) {

                // alert(  JSON.stringify( properties , null, 4)) ;

                if (properties != null && properties.item != null) {

                    var booking = items.get(properties.item);

                    // w2popup.open({
                    //     title: 'Selected Item ',
                    //     with: 600,
                    //     height: 550,
                    //     body: JSON.stringify(booking.recordData),
                    //     actions: { Ok: w2popup.close }
                    // })



                    w2ui['myForm'].setValue('name', booking.recordData.name);
                    w2ui['myForm'].setValue('country', booking.recordData.country);

                    w2ui['myForm'].setValue('startDate', booking.recordData.startDate);
                    w2ui['myForm'].setValue('endDate', booking.recordData.endDate);
                    w2ui['myForm'].setValue('numOfNights', booking.recordData.numOfNights);

                    w2ui['myForm'].setValue('balance', financial(booking.recordData.balance));
                    w2ui['myForm'].setValue('charge', financial(booking.recordData.charge));
                    w2ui['myForm'].setValue('received', financial(booking.recordData.received));
                    w2ui['myForm'].setValue('commission', financial( booking.recordData.commission));

                    w2ui['myForm'].setValue('numOfGuests', booking.recordData.numOfGuests);

                    w2ui['myForm'].setValue('agency', booking.recordData.agency);
                    w2ui['myForm'].setValue('room', booking.recordData.room);

                    w2ui['myForm'].setValue('voucher', booking.recordData.voucher);
                    w2ui['myForm'].setValue('email', booking.recordData.email);
                    w2ui['myForm'].setValue('tel', booking.recordData.tel);
                    w2ui['myForm'].setValue('identification', booking.recordData.identification);

                    w2ui['myForm'].setValue('invoiceNumber', booking.recordData.invoiceNumber);
                    w2ui['myForm'].setValue('taxRefNumber', booking.recordData.taxRefNumber);

                    w2ui['myForm'].setValue('afm', booking.recordData.afm);
                    w2ui['myForm'].setValue('extraInfo', booking.recordData.extraInfo);
                    
                    w2ui['myForm'].setValue('status', booking.recordData.status);


                    w2ui['myForm'].refresh();


                    // todo  load the form with the selected item from the timeline 

                }

            });

            // timeline.on('doubleClick', function (properties) {
            //     console.log("Double click event fired");
            //     w2alert('Not me!! The other button');
            // });

        });



    </script>



</body>

</html>